---
title: "Mortality Data quality and plausibility Report"
subtitle: "`r Sys.Date()`"
output: html_document
---

<style>
.tocify-subheader {
  font-size: 0.7em;
}
.tocify-item {
  font-size: 0.85em;
  padding-left: 25px;
  text-indent: 0;
}
</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
options(scipen = 999)
```

```{r logo, echo=FALSE}
htmltools::img(src = knitr::image_uri("resources/Logo_Reach_RGB_1.png"),
               alt = "REACH logo",
               style = 'position:absolute; top:0; right:0; padding:0; margin:20; width:250px')
```

```{r, include=FALSE, eval=TRUE}
if(file.exists("inputs/environment.Rdata")) {
  load("inputs/environment.Rdata")
}
path.raw <- svDialogs::dlg_open(multiple = F, title = "Please select your data excel file.")$res
path.tool <- svDialogs::dlg_open(multiple = F, title = "Please select your Kobo tool file.")$res
tool.survey <- readxl::read_excel(path.tool, "survey")
tool.choices <- readxl::read_excel(path.tool, "choices")
main.sheets <- readxl::excel_sheets(path.raw)
if(!file.exists("inputs/environment.Rdata")){
  path.sheet.with.main <- tcltk::tk_select.list(main.sheets, title = "Main Sheet", multiple = F)
  path.sheet.with.roster <- tcltk::tk_select.list(main.sheets, title = "HH Roster Sheet", multiple = F)
  path.sheet.with.leavers <- tcltk::tk_select.list(main.sheets, title = "Left Members Sheet", multiple = F)
  path.sheet.with.death <- tcltk::tk_select.list(main.sheets, title = "Died Members sheet", multiple = F)
  label_colname <- tcltk::tk_select.list(names(tool.survey)[grepl("label",names(tool.survey))], title = "Label column to choose", multiple = F)
}
raw.main <- readxl::read_excel(path.raw, path.sheet.with.main)
raw.hh_roster <- readxl::read_excel(path.raw, path.sheet.with.roster)
raw.left_member <- readxl::read_excel(path.raw, path.sheet.with.leavers)
raw.died_member <- readxl::read_excel(path.raw, path.sheet.with.death)
```

# {.tabset .tabset-fade}



```{r, echo=FALSE, warning=FALSE,include=FALSE}
if(!file.exists("inputs/environment.Rdata")) {
  ## Detect date of data collection column
  date_dc <- names(raw.main)[grepl("today",names(raw.main))]
  if(length(date_dc) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", date_dc, "' the correct date of data collection column?"), type = "yesno")$res
    if(yes_no == "no"){
      date_dc <- svDialogs::dlg_input(message= "Enter the name of the date of data collection column","date_dc")$res
    }
  } else if (length(date_dc) > 1){
    date_dc <- tcltk::tk_select.list(date_dc, title = "Date of data collection column")
  } else if (length(date_dc) == 0) {
    date_dc <- svDialogs::dlg_input(message= "Enter the name of the date of data collection column","date_dc")$res
  }
  
  ## Detect Recall date column
  date_recall_event <- names(raw.main)[grepl("recall",names(raw.main))]
  if(length(date_recall_event) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", date_recall_event, "' the correct recall date column?"), type = "yesno")$res
    if(yes_no == "no"){
      date_recall_event <- svDialogs::dlg_input(message= "Enter the name of the recall date column","date_recall_event")$res
    }
  } else if (length(date_recall_event) > 1){
    date_recall_event <- tcltk::tk_select.list(date_recall_event, title = "Recall date column")
  } else if (length(date_recall_event) == 0) {
    date_recall_event <- svDialogs::dlg_input(message= "Enter the name of the recall date column","date_recall_event")$res
  }
  
  ## Detect Enumerator column
  enumerator <- names(raw.main)[grepl("enum|team",names(raw.main))]
  
  if(length(enumerator) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", enumerator, "' the correct enumerator column?"), type = "yesno")$res
    if(yes_no == "no"){
      enumerator <- svDialogs::dlg_input(message= "Enter the name of the Enumerator Column","enumerator")$res
    }
  } else if (length(enumerator) > 1){
    enumerator <- tcltk::tk_select.list(enumerator, title = "Enumerator Column")
  } else if (length(enumerator) == 0) {
    enumerator <- svDialogs::dlg_input(message= "Enter the name of the Enumerator Column","enumerator")$res
  }
  
  ## Detect Admin1 column
  admin1 <- names(raw.main)[grepl("admin",names(raw.main))]
  
  if(length(admin1) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", admin1, "' the correct admin1 column?"), type = "yesno")$res
    if(yes_no == "no"){
      admin1 <- svDialogs::dlg_input(message= "Enter the name of the Admin 1 Column","admin1")$res
    }
  } else if (length(admin1) > 1){
    admin1 <- tcltk::tk_select.list(admin1, title = "Admin 1 Column")
  } else if (length(admin1) == 0) {
    admin1 <- svDialogs::dlg_input(message= "Enter the name of the Admin 1 Column","admin1")$res
  }
  
  ## Detect Admin1 column
  admin2 <- names(raw.main)[grepl("admin",names(raw.main))]
  
  if(length(admin2) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", admin2, "' the correct admin2 column?"), type = "yesno")$res
    if(yes_no == "no"){
      admin2 <- svDialogs::dlg_input(message= "Enter the name of the Admin 2 Column","admin2")$res
    }
  } else if (length(admin2) > 1){
    admin2 <- tcltk::tk_select.list(admin2, title = "Admin 2 Column")
  } else if (length(admin2) == 0) {
    admin2 <- svDialogs::dlg_input(message= "Enter the name of the Admin 2 Column","admin2")$res
  }
  
  ## Detect Cluster column
  cluster <- names(raw.main)[grepl("cluster",names(raw.main))]
  
  if(length(cluster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", cluster, "' the correct cluster column?"), type = "yesno")$res
    if(yes_no == "no"){
      cluster <- svDialogs::dlg_input(message= "Enter the name of the Cluster Column","cluster")$res
    }
  } else if (length(cluster) > 1){
    cluster <- tcltk::tk_select.list(cluster, title = "Cluster Column")
  } else if (length(cluster) == 0) {
    cluster <- svDialogs::dlg_input(message= "Enter the name of the Cluster Column","cluster")$res
  }
  
  ## Detect uuid_main column
  uuid_main <- names(raw.main)[grepl("uuid",names(raw.main))]
  
  if(length(uuid_main) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", uuid_main, "' the correct HH UUID column in main data?"), type = "yesno")$res
    if(yes_no == "no"){
      uuid_main <- svDialogs::dlg_input(message= "Enter the name of the HH UUID Column in main data","uuid_main")$res
    }
  } else if (length(uuid_main) > 1){
    uuid_main <- tcltk::tk_select.list(uuid_main, title = "HH UUID Column [Main Data]")
  } else if (length(uuid_main) == 0) {
    uuid_main <- svDialogs::dlg_input(message= "Enter the name of the HH UUID Column in main data","uuid_main")$res
  }
  
  ## Detect uuid_roster column
  uuid_roster <- names(raw.hh_roster)[grepl("uuid",names(raw.hh_roster))]
  
  if(length(uuid_roster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", uuid_roster, "' the correct HH UUID column in roster data?"), type = "yesno")$res
    if(yes_no == "no"){
      uuid_roster <- svDialogs::dlg_input(message= "Enter the name of the HH UUID Column in roster data","uuid_roster")$res
    }
  } else if (length(uuid_roster) > 1){
    uuid_roster <- tcltk::tk_select.list(uuid_roster, title = "HH UUID Column [Roster Data]")
  } else if (length(uuid_roster) == 0) {
    uuid_roster <- svDialogs::dlg_input(message= "Enter the name of the HH UUID Column in roster data","uuid_roster")$res
  }
  
  ## Detect sex_roster column
  sex_roster <- names(raw.hh_roster)[grepl("sex",names(raw.hh_roster))]
  
  if(length(sex_roster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", sex_roster, "' the correct sex roster column?"), type = "yesno")$res
    if(yes_no == "no"){
      sex_roster <- svDialogs::dlg_input(message= "Enter the name of the sex roster column","sex_roster")$res
    }
  } else if (length(sex_roster) > 1){
    sex_roster <- tcltk::tk_select.list(sex_roster, title = "Sex Column [Roster Data]")
  } else if (length(sex_roster) == 0) {
    sex_roster <- svDialogs::dlg_input(message= "Enter the name of the sex roster column","sex_roster")$res
  }
  
  ## Detect age_roster column
  age_roster <- names(raw.hh_roster)[grepl("final",names(raw.hh_roster))]
  
  if(length(age_roster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", age_roster, "' the correct age roster column?"), type = "yesno")$res
    if(yes_no == "no"){
      age_roster <- svDialogs::dlg_input(message= "Enter the name of the age roster column","age_roster")$res
    }
  } else if (length(age_roster) > 1){
    age_roster <- tcltk::tk_select.list(age_roster, title = "Age Column [Roster Data]")
  } else if (length(age_roster) == 0) {
    age_roster <- svDialogs::dlg_input(message= "Enter the name of the age roster column","age_roster")$res
  }
  
  ## Detect joined_roster column
  joined_roster <- names(raw.hh_roster)[grepl("join",names(raw.hh_roster))]
  
  if(length(joined_roster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", joined_roster, "' the correct joined roster column?"), type = "yesno")$res
    if(yes_no == "no"){
      joined_roster <- svDialogs::dlg_input(message= "Enter the name of the joined roster column","joined_roster")$res
    }
  } else if (length(joined_roster) > 1){
    joined_roster <- tcltk::tk_select.list(joined_roster, title = "Joined Column [Roster Data]")
  } else if (length(joined_roster) == 0) {
    joined_roster <- svDialogs::dlg_input(message= "Enter the name of the joined roster column","joined_roster")$res
  }
  
  ## Detect joined_date_roster column
  joined_date_roster <- names(raw.hh_roster)[grepl("final",names(raw.hh_roster))]
  
  if(length(joined_date_roster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", joined_date_roster, "' the correct joined date roster column?"), type = "yesno")$res
    if(yes_no == "no"){
      joined_date_roster <- svDialogs::dlg_input(message= "Enter the name of the joined date roster column","joined_date_roster")$res
    }
  } else if (length(joined_date_roster) > 1){
    joined_date_roster <- tcltk::tk_select.list(joined_date_roster, title = "Joined Date Column [Roster Data]")
  } else if (length(joined_date_roster) == 0) {
    joined_date_roster <- svDialogs::dlg_input(message= "Enter the name of the joined date roster column","joined_date_roster")$res
  }
  
  ## Detect birth_roster column
  birth_roster <- names(raw.hh_roster)[grepl("born",names(raw.hh_roster))]
  
  if(length(birth_roster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", birth_roster, "' the correct birth roster column?"), type = "yesno")$res
    if(yes_no == "no"){
      birth_roster <- svDialogs::dlg_input(message= "Enter the name of the birth roster column","birth_roster")$res
    }
  } else if (length(birth_roster) > 1){
    birth_roster <- tcltk::tk_select.list(birth_roster, title = "Birth Column [Roster Data]")
  } else if (length(birth_roster) == 0) {
    birth_roster <- svDialogs::dlg_input(message= "Enter the name of the birth roster column","birth_roster")$res
  }
  
  ## Detect birthdate_roster column
  birthdate_roster <- names(raw.hh_roster)[grepl("dob",names(raw.hh_roster))]
  
  if(length(birthdate_roster) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", birthdate_roster, "' the correct birth date roster column?"), type = "yesno")$res
    if(yes_no == "no"){
      birthdate_roster <- svDialogs::dlg_input(message= "Enter the name of the birth date roster column","birthdate_roster")$res
    }
  } else if (length(birthdate_roster) > 1){
    birthdate_roster <- tcltk::tk_select.list(birthdate_roster, title = "Birth date Column [Roster Data]")
  } else if (length(birthdate_roster) == 0) {
    birthdate_roster <- svDialogs::dlg_input(message= "Enter the name of the birth date roster column","birthdate_roster")$res
  }
  
  ## Detect uuid_left column
  uuid_left <- names(raw.left_member)[grepl("uuid",names(raw.left_member))]
  
  if(length(uuid_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", uuid_left, "' the correct HH UUID column in left data?"), type = "yesno")$res
    if(yes_no == "no"){
      uuid_left <- svDialogs::dlg_input(message= "Enter the name of the HH UUID column in left data","uuid_left")$res
    }
  } else if (length(uuid_left) > 1){
    uuid_left <- tcltk::tk_select.list(uuid_left, title = "HH UUID Column [Left Data]")
  } else if (length(uuid_left) == 0) {
    uuid_left <- svDialogs::dlg_input(message= "Enter the name of the HH UUID column in left data","uuid_left")$res
  }
  
  ## Detect sex_left column
  sex_left <- names(raw.left_member)[grepl("sex",names(raw.left_member))]
  
  if(length(sex_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", sex_left, "' the correct sex left column?"), type = "yesno")$res
    if(yes_no == "no"){
      sex_left <- svDialogs::dlg_input(message= "Enter the name of the sex left column","sex_left")$res
    }
  } else if (length(sex_left) > 1){
    sex_left <- tcltk::tk_select.list(sex_left, title = "Sex date Column [Left Data]")
  } else if (length(sex_left) == 0) {
    sex_left <- svDialogs::dlg_input(message= "Enter the name of the sex left column","sex_left")$res
  }
  
  ## Detect age_left column
  age_left <- names(raw.left_member)[grepl("final",names(raw.left_member))]
  
  if(length(age_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", age_left, "' the correct age left column?"), type = "yesno")$res
    if(yes_no == "no"){
      age_left <- svDialogs::dlg_input(message= "Enter the name of the age left column","age_left")$res
    }
  } else if (length(age_left) > 1){
    age_left <- tcltk::tk_select.list(age_left, title = "Age date Column [Left Data]")
  } else if (length(age_left) == 0) {
    age_left <- svDialogs::dlg_input(message= "Enter the name of the age left column","age_left")$res
  }
  
  ## Detect birth_left column
  birth_left <- names(raw.left_member)[grepl("born",names(raw.left_member))]
  
  if(length(birth_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", birth_left, "' the correct birth column?"), type = "yesno")$res
    if(yes_no == "no"){
      birth_left <- svDialogs::dlg_input(message= "Enter the name of the birth column","birth_left")$res
    }
  } else if (length(birth_left) > 1){
    birth_left <- tcltk::tk_select.list(birth_left, title = "Birth date Column [Left Data]")
  } else if (length(birth_left) == 0) {
    birth_left <- svDialogs::dlg_input(message= "Enter the name of the birth column","birth_left")$res
  }
  
  ## Detect birthdate_left column
  birthdate_left <- names(raw.left_member)[grepl("dob",names(raw.left_member))]
  
  if(length(birthdate_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", birthdate_left, "' the correct birth date column?"), type = "yesno")$res
    if(yes_no == "no"){
      birthdate_left <- svDialogs::dlg_input(message= "Enter the name of the birth date column","birthdate_left")$res
    }
  } else if (length(birthdate_left) > 1){
    birthdate_left <- tcltk::tk_select.list(birthdate_left, title = "Birth date Column [Left Data]")
  } else if (length(birthdate_left) == 0) {
    birthdate_left <- svDialogs::dlg_input(message= "Enter the name of the birth date column","birthdate_left")$res
  }
  
  ## Detect joined_left column
  joined_left <- names(raw.left_member)[grepl("present",names(raw.left_member))]
  
  if(length(joined_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", joined_left, "' the correct joined column in left data?"), type = "yesno")$res
    if(yes_no == "no"){
      joined_left <- svDialogs::dlg_input(message= "Enter the name of the joined column in left data","joined_left")$res
    }
  } else if (length(joined_left) > 1){
    joined_left <- tcltk::tk_select.list(joined_left, title = "Joined Column [Left Data]")
  } else if (length(joined_left) == 0) {
    joined_left <- svDialogs::dlg_input(message= "Enter the name of the joined column in left data","joined_left")$res
  }
  
  ## Detect joined_date_left column
  joined_date_left <- names(raw.left_member)[grepl("final",names(raw.left_member))]
  
  if(length(joined_date_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", joined_date_left, "' the correct joined date column in left data?"), type = "yesno")$res
    if(yes_no == "no"){
      joined_date_left <- svDialogs::dlg_input(message= "Enter the name of the joined date column in left data","joined_date_left")$res
    }
  } else if (length(joined_date_left) > 1){
    joined_date_left <- tcltk::tk_select.list(joined_date_left, title = "Joined date Column [Left Data]")
  } else if (length(joined_date_left) == 0) {
    joined_date_left <- svDialogs::dlg_input(message= "Enter the name of the joined date column in left data","joined_date_left")$res
  }
  
  ## Detect left_date_left column
  left_date_left <- names(raw.left_member)[grepl("final",names(raw.left_member))]
  
  if(length(left_date_left) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", left_date_left, "' the correct left date column?"), type = "yesno")$res
    if(yes_no == "no"){
      left_date_left <- svDialogs::dlg_input(message= "Enter the name of the left date column","left_date_left")$res
    }
  } else if (length(left_date_left) > 1){
    left_date_left <- tcltk::tk_select.list(left_date_left, title = "Left date Column [Left Data]")
  } else if (length(left_date_left) == 0) {
    left_date_left <- svDialogs::dlg_input(message= "Enter the name of the left date column","left_date_left")$res
  }
  
  ## Detect uuid_died column
  uuid_died <- names(raw.died_member)[grepl("uuid",names(raw.died_member))]
  
  if(length(uuid_died) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", uuid_died, "' the correct HH UUID column in died data?"), type = "yesno")$res
    if(yes_no == "no"){
      uuid_died <- svDialogs::dlg_input(message= "Enter the name of the HH UUID column in died data","uuid_died")$res
    }
  } else if (length(uuid_died) > 1){
    uuid_died <- tcltk::tk_select.list(uuid_died, title = "HH UUID Column [Died Data]")
  } else if (length(uuid_died) == 0) {
    uuid_died <- svDialogs::dlg_input(message= "Enter the name of the HH UUID column in died data","uuid_died")$res
  }
  
  ## Detect sex_died column
  sex_died <- names(raw.died_member)[grepl("sex",names(raw.died_member))]
  
  if(length(sex_died) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", sex_died, "' the correct sex died column?"), type = "yesno")$res
    if(yes_no == "no"){
      sex_died <- svDialogs::dlg_input(message= "Enter the name of the sex died column","sex_died")$res
    }
  } else if (length(sex_died) > 1){
    sex_died <- tcltk::tk_select.list(sex_died, title = "Sex date Column [Died Data]")
  } else if (length(sex_died) == 0) {
    sex_died <- svDialogs::dlg_input(message= "Enter the name of the sex died column","sex_died")$res
  }
  
  ## Detect age_died column
  age_died <- names(raw.died_member)[grepl("final",names(raw.died_member))]
  
  if(length(age_died) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", age_died, "' the correct age died column?"), type = "yesno")$res
    if(yes_no == "no"){
      age_died <- svDialogs::dlg_input(message= "Enter the name of the age died column","age_died")$res
    }
  } else if (length(age_died) > 1){
    age_died <- tcltk::tk_select.list(age_died, title = "Age date Column [Died Data]")
  } else if (length(age_died) == 0) {
    age_died <- svDialogs::dlg_input(message= "Enter the name of the age died column","age_died")$res
  }
  
  ## Detect birth_died column
  birth_died <- names(raw.died_member)[grepl("born",names(raw.died_member))]
  
  if(length(birth_died) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", birth_died, "' the correct birth column?"), type = "yesno")$res
    if(yes_no == "no"){
      birth_died <- svDialogs::dlg_input(message= "Enter the name of the birth column","birth_died")$res
    }
  } else if (length(birth_died) > 1){
    birth_died <- tcltk::tk_select.list(birth_died, title = "Birth Column [Died Data]")
  } else if (length(birth_died) == 0) {
    birth_died <- svDialogs::dlg_input(message= "Enter the name of the birth column","birth_died")$res
  }
  
  ## Detect birthdate_died column
  birthdate_died <- names(raw.died_member)[grepl("dob",names(raw.died_member))]
  
  if(length(birthdate_died) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", birthdate_died, "' the correct birth date column?"), type = "yesno")$res
    if(yes_no == "no"){
      birthdate_died <- svDialogs::dlg_input(message= "Enter the name of the birth date column","birthdate_died")$res
    }
  } else if (length(birthdate_died) > 1){
    birthdate_died <- tcltk::tk_select.list(birthdate_died, title = "Birth date Column [Died Data]")
  } else if (length(birthdate_died) == 0) {
    birthdate_died <- svDialogs::dlg_input(message= "Enter the name of the birth date column","birthdate_died")$res
  }
  
  
  ## Detect joined_died column
  joined_died <- names(raw.died_member)[grepl("present",names(raw.died_member))]
  
  if(length(joined_died) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", joined_died, "' the correct joined column in died data?"), type = "yesno")$res
    if(yes_no == "no"){
      joined_died <- svDialogs::dlg_input(message= "Enter the name of the joined column in died data","joined_died")$res
    }
  } else if (length(joined_died) > 1){
    joined_died <- tcltk::tk_select.list(joined_died, title = "Joined Column [Died Data]")
  } else if (length(joined_died) == 0) {
    joined_died <- svDialogs::dlg_input(message= "Enter the name of the joined column in died data","joined_died")$res
  }
  
  ## Detect joined_date_died column
  joined_date_died <- names(raw.died_member)[grepl("final",names(raw.died_member))]
  
  if(length(joined_date_died) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", joined_date_died, "' the correct joined date column in died data?"), type = "yesno")$res
    if(yes_no == "no"){
      joined_date_died <- svDialogs::dlg_input(message= "Enter the name of the joined date column in died data","joined_date_died")$res
    }
  } else if (length(joined_date_died) > 1){
    joined_date_died <- tcltk::tk_select.list(joined_date_died, title = "Joined date Column [Died Data]")
  } else if (length(joined_date_died) == 0) {
    joined_date_died <- svDialogs::dlg_input(message= "Enter the name of the joined date column in died data","joined_date_died")$res
  }
  
  ## Detect date_death column
  date_death <- names(raw.died_member)[grepl("final",names(raw.died_member))]
  
  if(length(date_death) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", date_death, "' the correct death date column in died data?"), type = "yesno")$res
    if(yes_no == "no"){
      date_death <- svDialogs::dlg_input(message= "Enter the name of the death date column in died data","date_death")$res
    }
  } else if (length(date_death) > 1){
    date_death <- tcltk::tk_select.list(date_death, title = "Death date Column [Died Data]")
  } else if (length(date_death) == 0) {
    date_death <- svDialogs::dlg_input(message= "Enter the name of the death date column in died data","date_death")$res
  }
  
  ## Detect death_cause column
  death_cause <- names(raw.died_member)[grepl("cause",names(raw.died_member))]
  
  if(length(death_cause) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", death_cause, "' the correct cause of death column?"), type = "yesno")$res
    if(yes_no == "no"){
      death_cause <- svDialogs::dlg_input(message= "Enter the name of the cause of death column","death_cause")$res
    }
  } else if (length(death_cause) > 1){
    death_cause <- tcltk::tk_select.list(death_cause, title = "Cause of Death Column [Died Data]")
  } else if (length(death_cause) == 0) {
    death_cause <- svDialogs::dlg_input(message= "Enter the name of the cause of death column","death_cause")$res
  }
  
  ## Detect death_location column
  death_location <- names(raw.died_member)[grepl("location",names(raw.died_member))]
  
  if(length(death_location) == 1){
    yes_no <- svDialogs::dlg_message(paste0("Is '", death_location, "' the correct location of death column?"), type = "yesno")$res
    if(yes_no == "no"){
      death_location <- svDialogs::dlg_input(message= "Enter the name of the location of death column","death_location")$res
    }
  } else if (length(death_location) > 1){
    death_location <- tcltk::tk_select.list(death_location, title = "Location of Death Column [Died Data]")
  } else if (length(death_location) == 0) {
    death_location <- svDialogs::dlg_input(message= "Enter the name of the location of death column","death_location")$res
  }
  
  smart <- tcltk::tk_select.list(c(TRUE,FALSE), title = "Do you have all the Dates Collected? (1 for Yes, 0 for No")
  

}
  all_vars <- ls()
  is_empty <- function(x) {
  obj <- get(x)
  length(obj) == 0 || is.null(obj) ||  (is.character(obj) && all(obj == ""))
  }
  empty_vars <- all_vars[sapply(all_vars, is_empty)]
  
  for (i in empty_vars) {
    assign(i, NULL)
  }
  if(!is.null(date_dc)){
    if(!purrr::is_empty(date_dc)){
      if(date_dc %in% names(raw.main)){
        raw.main <- raw.main %>%
          dplyr::mutate(!!rlang::sym(date_dc) := ifelse(is.na(!!rlang::sym(date_dc)), NA,
                                                        ifelse(nchar(!!rlang::sym(date_dc)) == 5,
                                                               lubridate::as_date(as.numeric(!!rlang::sym(date_dc)), origin = "1899-12-30"),
                                                               stringr::str_sub(string = !!rlang::sym(date_dc), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(date_recall_event)){
    if(!purrr::is_empty(date_recall_event)){
      if(date_recall_event %in% names(raw.main)){
        raw.main <- raw.main %>%
          dplyr::mutate(!!rlang::sym(date_recall_event) := ifelse(is.na(!!rlang::sym(date_recall_event)), NA,
                                                                  ifelse(nchar(!!rlang::sym(date_recall_event)) == 5,
                                                                         lubridate::as_date(as.numeric(!!rlang::sym(date_recall_event)), origin = "1899-12-30"),
                                                                         stringr::str_sub(string = !!rlang::sym(date_recall_event), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(birthdate_roster)){
    if(!purrr::is_empty(birthdate_roster)){
      if(birthdate_roster %in% names(raw.hh_roster)){
        raw.hh_roster <- raw.hh_roster %>%
          dplyr::mutate(age_years = NULL,
                        !!rlang::sym(birthdate_roster) := ifelse(is.na(!!rlang::sym(birthdate_roster)), NA,
                                                                 ifelse(nchar(!!rlang::sym(birthdate_roster)) == 5,
                                                                        lubridate::as_date(as.numeric(!!rlang::sym(birthdate_roster)), origin = "1899-12-30"),
                                                                        stringr::str_sub(string = !!rlang::sym(birthdate_roster), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(joined_date_roster)){
    if(!purrr::is_empty(joined_date_roster)){
      if(joined_date_roster %in% names(raw.hh_roster)){
        raw.hh_roster <- raw.hh_roster %>%
          dplyr::mutate(age_years = NULL,
                        !!rlang::sym(joined_date_roster) := ifelse(is.na(!!rlang::sym(joined_date_roster)), NA,
                                                                   ifelse(nchar(!!rlang::sym(joined_date_roster)) == 5,
                                                                          lubridate::as_date(as.numeric(!!rlang::sym(joined_date_roster)), origin = "1899-12-30"),
                                                                          stringr::str_sub(string = !!rlang::sym(joined_date_roster), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(birthdate_left)){
    if(!purrr::is_empty(birthdate_left)){
      if(birthdate_left %in% names(raw.left_member)){
        raw.left_member <- raw.left_member %>%
          dplyr::mutate(!!rlang::sym(birthdate_left) := ifelse(is.na(!!rlang::sym(birthdate_left)), NA,
                                                               ifelse(nchar(!!rlang::sym(birthdate_left)) == 5,
                                                                      lubridate::as_date(as.numeric(!!rlang::sym(birthdate_left)), origin = "1899-12-30"),
                                                                      stringr::str_sub(string = !!rlang::sym(birthdate_left), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(joined_date_left)){
    if(!purrr::is_empty(joined_date_left)){
      if(joined_date_left %in% names(raw.left_member)){
        raw.left_member <- raw.left_member %>%
          dplyr::mutate(!!rlang::sym(joined_date_left) := ifelse(is.na(!!rlang::sym(joined_date_left)), NA,
                                                                 ifelse(nchar(!!rlang::sym(joined_date_left)) == 5,
                                                                        lubridate::as_date(as.numeric(!!rlang::sym(joined_date_left)), origin = "1899-12-30"),
                                                                        stringr::str_sub(string = !!rlang::sym(joined_date_left), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(left_date_left)){
    if(!purrr::is_empty(left_date_left)){
      if(left_date_left %in% names(raw.left_member)){
        raw.left_member <- raw.left_member %>%
          dplyr::mutate(!!rlang::sym(left_date_left) := ifelse(is.na(!!rlang::sym(left_date_left)), NA,
                                                               ifelse(nchar(!!rlang::sym(left_date_left)) == 5,
                                                                      lubridate::as_date(as.numeric(!!rlang::sym(left_date_left)), origin = "1899-12-30"),
                                                                      stringr::str_sub(string = !!rlang::sym(left_date_left), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(birthdate_died)){
    if(!purrr::is_empty(birthdate_died)){
      if(birthdate_died %in% names(raw.died_member)){
        raw.died_member <- raw.died_member %>%
          dplyr::mutate(!!rlang::sym(birthdate_died) := ifelse(is.na(!!rlang::sym(birthdate_died)), NA,
                                                               ifelse(nchar(!!rlang::sym(birthdate_died)) == 5,
                                                                      lubridate::as_date(as.numeric(!!rlang::sym(birthdate_died)), origin = "1899-12-30"),
                                                                      stringr::str_sub(string = !!rlang::sym(birthdate_died), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(date_death)){
    if(!purrr::is_empty(date_death)){
      if(date_death %in% names(raw.died_member)){
        raw.died_member <- raw.died_member %>%
          dplyr::mutate(!!rlang::sym(date_death) := ifelse(is.na(!!rlang::sym(date_death)), NA,
                                                           ifelse(nchar(!!rlang::sym(date_death)) == 5,
                                                                  lubridate::as_date(as.numeric(!!rlang::sym(date_death)), origin = "1899-12-30"),
                                                                  stringr::str_sub(string = !!rlang::sym(date_death), start = 1, end = 10))))
      }
    }
  }

  if(!is.null(joined_date_died)){
    if(!purrr::is_empty(joined_date_died)){
      if(joined_date_died %in% names(raw.died_member)){
        raw.died_member <- raw.died_member %>%
          dplyr::mutate(!!rlang::sym(joined_date_died) := ifelse(is.na(!!rlang::sym(joined_date_died)), NA,
                                                                 ifelse(nchar(!!rlang::sym(joined_date_died)) == 5,
                                                                        lubridate::as_date(as.numeric(!!rlang::sym(joined_date_died)), origin = "1899-12-30"),
                                                                        stringr::str_sub(string = !!rlang::sym(joined_date_died), start = 1, end = 10))))
      }
    }
  }
# Slicer
# source("src/date_selection.R")
min_date <- min(raw.main[[date_dc]])
max_date <- max(raw.main[[date_dc]])
# selected_dates <- date_range_input(min_date, max_date)

### TO CONTINUE HERE
min_filter <- svDialogs::dlg_input(message= paste0("Enter the start date (format: YYYY-MM-DD). Range: ", min_date, " and ", max_date),min_date)$res

max_filter <- svDialogs::dlg_input(message= paste0("Enter the end date (format: YYYY-MM-DD). Range: ", min_date, " and ", max_date),max_date)$res

while(!stringr::str_detect(min_filter,"^\\d{4}\\-(0?[1-9]|1[012])\\-(0?[1-9]|[12][0-9]|3[01])$") | 
        lubridate::as_date(min_filter) < lubridate::as_date(min_date) |
      lubridate::as_date(min_filter) > lubridate::as_date(max_filter)){
    min_filter <- svDialogs::dlg_input(message= paste0("[INCORRECT] Re-enter the start date (format: YYYY-MM-DD). Range: ", min_date, " and ", max_date),min_date)$res
}
  
while(!stringr::str_detect(max_filter,"^\\d{4}\\-(0?[1-9]|1[012])\\-(0?[1-9]|[12][0-9]|3[01])$")| 
      lubridate::as_date(max_filter) > lubridate::as_date(max_date) |
      lubridate::as_date(max_filter) < lubridate::as_date(min_filter)){
    max_filter <- svDialogs::dlg_input(message= paste0("[INCORRECT] Re-enter the end date (format: YYYY-MM-DD). Range: ", min_date, " and ", max_date),max_date)$res
}

raw.main <- raw.main %>% 
  filter(lubridate::as_date(!!rlang::sym(date_dc)) >= min_filter &
           lubridate::as_date(!!rlang::sym(date_dc)) <= max_filter)

uuid_filter <- raw.main[[uuid_main]]

raw.hh_roster <- raw.hh_roster %>% 
  filter(!!rlang::sym(uuid_roster) %in% uuid_filter)

raw.left_member <- raw.left_member %>% 
  filter(!!rlang::sym(uuid_left) %in% uuid_filter)


raw.died_member <- raw.died_member %>% 
  filter(!!rlang::sym(uuid_died) %in% uuid_filter)

df_mortality_long <- impactR4PHU::create_mortality_long_df(df_main = raw.main,
                                                           date_dc = date_dc,
                                                           date_recall_event = date_recall_event,
                                                           enumerator = enumerator,
                                                           admin1 = admin1,
                                                           admin2 = admin2,
                                                           cluster = cluster,
                                                           uuid_main = uuid_main,
                                                           df_roster = raw.hh_roster,
                                                           uuid_roster = uuid_roster,
                                                           sex_roster = sex_roster,
                                                           age_roster = age_roster,
                                                           joined_roster = joined_roster,
                                                           joined_date_roster = joined_date_roster,
                                                           birth_roster = birth_roster,
                                                           birthdate_roster = birthdate_roster,
                                                           df_left = raw.left_member,
                                                           uuid_left = uuid_left,
                                                           sex_left = sex_left,
                                                           age_left = age_left,
                                                           birth_left = birth_left,
                                                           birthdate_left = birthdate_left,
                                                           joined_left = joined_left,
                                                           joined_date_left = joined_date_left,
                                                           left_date_left = left_date_left,
                                                           df_died = raw.died_member,
                                                           uuid_died = uuid_died,
                                                           sex_died = sex_died,
                                                           age_died = age_died,
                                                           birth_died = birth_died,
                                                           birthdate_died = birthdate_died,
                                                           joined_died = joined_died,
                                                           joined_date_died = joined_date_died,
                                                           date_death = date_death,
                                                           death_cause = death_cause,
                                                           death_location = death_location)


if(!file.exists("inputs/environment.Rdata")) {
   if("sex" %in% names(df_mortality_long)){
    sex_codes <- unique(df_mortality_long$sex)
    ideal_codes <- c("1", "2")
    sex_recodes <- c("1", "2", "NA")

    if(length(setdiff(sex_codes, ideal_codes))==0) {
      male <- 1
      female <- 2
      print("Good - Sex coded as 1/2 for male/female")
    } else {
        male <- tcltk::tk_select.list(sex_codes, title = "Male Option", multiple = T)
        female <- tcltk::tk_select.list(sex_codes, title = "Female Option", multiple = T)
    }
   }
  
  if(c("date_dc") %in% names(df_mortality_long)) {

    date_recodes <- c("mdy", "dmy", "ymd", "ydm", "NA")
    unique_dates <- df_mortality_long %>% dplyr::filter(!is.na(date_dc)) %>% dplyr::select(date_dc) %>% t %>% c %>% unique
    date_dc_reformat <- svDialogs::dlg_input(message= paste0("Example of Date of Data collection values: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                              "\n RE-FORMATTING VARIABLE : DATE OF DATA COLLECTION \n What is the date format for the DATE OF DATA COLLECTION column? Please input : \n 'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    while(length(setdiff(date_dc_reformat, date_recodes))==1) {
      date_dc_reformat <- svDialogs::dlg_input(message= paste0("Example of Date of Data collection values: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                                "Invalid input. \n ", "\n RE-FORMATTING VARIABLE : DATE OF DATA COLLECTION \n How is DATE OF DATA COLLECTION formatted? Please input : \n  'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    }
  }
  
  
  if(c("date_recall") %in% names(df_mortality_long)) {

    dob_recodes <- c("mdy", "dmy", "ymd", "ydm", "NA")
    unique_dates <- df_mortality_long %>% dplyr::filter(!is.na(date_recall)) %>% dplyr::select(date_recall) %>% t %>% c %>% unique



    date_recall_reformat <- svDialogs::dlg_input(message= paste0("Example of RECALL DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                              "\n RE-FORMATTING VARIABLE : RECALL DATE \n What is the date format for the RECALL DATE formatted? Please input : \n 'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    while(length(setdiff(date_recall_reformat, dob_recodes))==1) {
      date_recall_reformat <- svDialogs::dlg_input(message= paste0("Example of RECALL DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                                "Invalid input. \n", "\n RE-FORMATTING VARIABLE : RECALL DATE \n How is RECALL DATE formatted? Please input : \n  'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    }
  }
  
  # Checking Date Join

  if(c("date_join") %in% names(df_mortality_long)) {

    dob_recodes <- c("mdy", "dmy", "ymd", "ydm", "NA")
    unique_dates <- df_mortality_long %>% dplyr::filter(!is.na(date_join)) %>% dplyr::select(date_join) %>% t %>% c %>% unique

    date_join_reformat <- svDialogs::dlg_input(message= paste0("Example of JOIN DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                              "\n RE-FORMATTING VARIABLE : JOIN DATE \n What is the date format for the JOIN DATE formatted? Please input : \n 'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA." ))$res
    while(length(setdiff(date_join_reformat, dob_recodes))==1) {
      date_join_reformat <- svDialogs::dlg_input(message= paste0("Example of JOIN DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                                "Invalid input. ", "\n RE-FORMATTING VARIABLE : JOIN DATE \n How is JOIN DATE formatted? Please input : \n  'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    }
  }
  
    # Checking Date Left

  if(c("date_left") %in% names(df_mortality_long)) {

    dob_recodes <- c("mdy", "dmy", "ymd", "ydm", "NA")
    unique_dates <- df_mortality_long %>% dplyr::filter(!is.na(date_left)) %>% dplyr::select(date_left) %>% t %>% c %>% unique

    date_left_reformat <- svDialogs::dlg_input(message= paste0("Example of LEFT DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                              "\n RE-FORMATTING VARIABLE : LEFT DATE \n What is the date format for the LEFT DATE formatted? Please input : \n 'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    while(length(setdiff(date_left_reformat, dob_recodes))==1) {
      date_left_reformat <- svDialogs::dlg_input(message= paste0("Example of LEFT DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                                "Invalid input. ", "\n RE-FORMATTING VARIABLE : LEFT DATE \n How is LEFT DATE formatted? Please input : \n  'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    }
  }
  
  
  # Checking Date Birth

  if(c("date_birth") %in% names(df_mortality_long)) {

    dob_recodes <- c("mdy", "dmy", "ymd", "ydm", "NA")
    unique_dates <- df_mortality_long %>% dplyr::filter(!is.na(date_birth)) %>% dplyr::select(date_birth) %>% t %>% c %>% unique

    date_birth_reformat <- svDialogs::dlg_input(message= paste0("Example of BIRTH DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                              "\n RE-FORMATTING VARIABLE : BIRTH DATE \n What is the date format for the BIRTH DATE formatted? Please input : \n 'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    while(length(setdiff(date_birth_reformat, dob_recodes))==1) {
      date_birth_reformat <- svDialogs::dlg_input(message= paste0("Example of BIRTH DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                                "Invalid input. ", "\n RE-FORMATTING VARIABLE : BIRTH DATE \n How is BIRTH DATE formatted? Please input : \n  'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    }
  }

  # Checking Date Death

  if(c("date_death") %in% names(df_mortality_long)) {

    dob_recodes <- c("mdy", "dmy", "ymd", "ydm", "NA")
    unique_dates <- df_mortality_long %>% dplyr::filter(!is.na(date_death)) %>% dplyr::select(date_death) %>% t %>% c %>% unique

    date_death_reformat <- svDialogs::dlg_input(message= paste0("Example of DEATH DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                              "\n RE-FORMATTING VARIABLE : DEATH DATE \n What is the date format for the DEATH DATE formatted? Please input : \n 'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    while(length(setdiff(date_death_reformat, dob_recodes))==1) {
      date_death_reformat <- svDialogs::dlg_input(message= paste0("Example of DEATH DATE value: ", if(length(unique_dates)>0) {unique_dates[[1]]}, " ", if(length(unique_dates)>1) {unique_dates[[2]]}, " ",if(length(unique_dates)>2) {unique_dates[[3]]},
                                                "Invalid input. ", "\n RE-FORMATTING VARIABLE : DEATH DATE \n How is DEATH DATE formatted? Please input : \n  'mdy' for months-day-year, \n 'dmy' for day-months-year \n 'ymd' for year-month-day \n 'ydm' for year-day-month \n 'NA' for NA."))$res
    }
  }
  
  # Checking Cause of Death Coding 

  cause_codes <- unique(df_mortality_long$death_cause)
  ideal_codes <- c("1", "2", "3")

  if(length(setdiff(cause_codes, ideal_codes))==0) {
    print("Good - Cause of Death coded as 1/2/3 for unknown/injury/illness")
  } else {
    unknown <- tcltk::tk_select.list(cause_codes, title = "Unknown Options [Cause of Death]", multiple = T)
    injury_trauma <- tcltk::tk_select.list(cause_codes, title = "Injury/trauma Options [Cause of Death]", multiple = T)
    illness <- tcltk::tk_select.list(cause_codes, title = "Illness Options [Cause of Death]", multiple = T)
  }

  # Checking Location of Death Coding
  location_codes <- unique(df_mortality_long$death_location)
  ideal_codes <- c("1", "2", "3", "4")

  if(length(setdiff(location_codes, ideal_codes))==0) {
    print("Good - Cause of Death coded as 1/2/3/4 for unknown/injury/illness")
  } else {
    current_location <- tcltk::tk_select.list(location_codes, title = "Current Location Options [LOCATION OF DEATH]", multiple = T)
    during_migration <- tcltk::tk_select.list(location_codes, title = "During Migration Options  [LOCATION OF DEATH]", multiple = T)
    last_place <- tcltk::tk_select.list(location_codes, title = "Last Place Residence Options [LOCATION OF DEATH]", multiple = T)
    other_place <- tcltk::tk_select.list(location_codes, title = "Other Place Options [LOCATION OF DEATH]", multiple = T)
  }
  
  demographic_vars <- c("join", "left", "birth", "death")

  list_to_check <- intersect(demographic_vars, names(df_mortality_long))
  df_mortality_long[list_to_check] <- lapply(df_mortality_long[list_to_check], as.character)
  list_to_check_codes <- df_mortality_long %>% dplyr::select(list_to_check) %>% t %>% c %>% unique

  ideal_codes <- c("1")

  if(length(setdiff(list_to_check_codes, ideal_codes))==0) {
    print("Good - The demographic variables are already coded as 1/0 for yes/no")
  } else {
      yes_demo_values <- tcltk::tk_select.list(list_to_check_codes, title = "Yes values [Demographic Column]", multiple = T)
      no_demo_values <- tcltk::tk_select.list(list_to_check_codes, title = "No/NA values [Demographic Column]", multiple = T)
  }

}

if(is.character(df_mortality_long$date_dc)) {
  df_mortality_long <- df_mortality_long %>% 
    dplyr::mutate(date_dc = ifelse(date_dc == "", NA, date_dc))
  }

if(is.character(df_mortality_long$date_recall)) {
  df_mortality_long <- df_mortality_long %>% 
    dplyr::mutate(date_recall = ifelse(date_recall == "", NA, date_recall))
  }

if(is.character(df_mortality_long$date_join)) {
  df_mortality_long <- df_mortality_long %>% 
    dplyr::mutate(date_join = ifelse(date_join == "", NA, date_join))
  }


if(is.character(df_mortality_long$date_left)) {
  df_mortality_long <- df_mortality_long %>% 
    dplyr::mutate(date_left = ifelse(date_left == "", NA, date_left))
  }


if(is.character(df_mortality_long$date_birth)) {
  df_mortality_long <- df_mortality_long %>% 
    dplyr::mutate(date_birth = ifelse(date_birth == "", NA, date_birth))
}


if(is.character(df_mortality_long$date_death)) {
  df_mortality_long <- df_mortality_long %>%
    dplyr::mutate(date_death = ifelse(date_death == "", NA, date_death))
}

df_mortality_long <- df_mortality_long  %>%
  dplyr::mutate(death_cause_smart = "",
                death_location_smart = "",
                sex = ifelse(is.na(sex),NA,
                             ifelse(sex == male, 1,
                                    ifelse(sex == female,2,sex))),
                date_dc_date = lubridate::parse_date_time(date_dc, orders = date_dc_reformat),
                date_dc_month = lubridate::month(date_dc_date),
                date_dc_day = lubridate::day(date_dc_date),
                date_dc_year = lubridate::year(date_dc_date),
                date_dc_char = paste(date_dc_month, date_dc_day, date_dc_year, sep = "/"),
                date_dc_char = ifelse(is.na(date_dc_char), NA, ifelse(date_dc_char == "NA/NA/NA", NA, date_dc_char)),
                date_recall_date = lubridate::parse_date_time(date_recall, orders = date_recall_reformat),
                date_recall_month = lubridate::month(date_recall_date),
                date_recall_day = lubridate::day(date_recall_date),
                date_recall_year = lubridate::year(date_recall_date),
                date_recall = paste(date_recall_month, date_recall_day, date_recall_year, sep = "/"),
                date_recall = ifelse(is.na(date_recall), NA, ifelse(date_recall == "NA/NA/NA", NA, date_recall)),
                date_join_date = lubridate::parse_date_time(date_join, orders = date_join_reformat),
                date_join_month = lubridate::month(date_join_date),
                date_join_day = lubridate::day(date_join_date),
                date_join_year = lubridate::year(date_join_date),
                date_join = paste(date_join_month, date_join_day, date_join_year, sep = "/"),
                date_join = ifelse(is.na(date_join), NA, ifelse(date_join == "NA/NA/NA", NA, date_join)),
                date_left_date = lubridate::parse_date_time(date_left, orders = date_left_reformat),
                date_left_month = lubridate::month(date_left_date),
                date_left_day = lubridate::day(date_left_date),
                date_left_year = lubridate::year(date_left_date),
                date_left = paste(date_left_month, date_left_day, date_left_year, sep = "/"),
                date_left = ifelse(is.na(date_left), NA, ifelse(date_left == "NA/NA/NA", NA, date_left)),
                date_birth_date = lubridate::parse_date_time(date_birth, orders = date_birth_reformat),
                date_birth_month = lubridate::month(date_birth_date),
                date_birth_day = lubridate::day(date_birth_date),
                date_birth_year = lubridate::year(date_birth_date),
                date_birth = paste(date_birth_month, date_birth_day, date_birth_year, sep = "/"),
                date_birth = ifelse(is.na(date_birth), NA, ifelse(date_birth == "NA/NA/NA", NA, date_birth)),
                date_death_date = lubridate::parse_date_time(date_death, orders = date_death_reformat),
                date_death_month = lubridate::month(date_death_date),
                date_death_day = lubridate::day(date_death_date),
                date_death_year = lubridate::year(date_death_date),
                date_death = paste(date_death_month, date_death_day, date_death_year, sep = "/"),
                date_death = ifelse(is.na(date_death), NA, ifelse(date_death == "NA/NA/NA", NA, date_death)),
                death_cause_smart = ifelse(is.na(death_cause),NA,
                                           ifelse(death_cause %in% unknown, 1,
                                                  ifelse(death_cause %in% injury_trauma, 2, 
                                                         ifelse(death_cause %in% illness, 3, death_cause_smart)))),
                death_location_smart = ifelse(is.na(death_location), NA,
                                               ifelse(death_location %in% current_location, 1,
                                                      ifelse(death_location %in% during_migration, 2,
                                                             ifelse(death_location %in% last_place, 3,
                                                                    ifelse(death_location %in% other_place,4,death_location_smart)))))) %>% 
  dplyr::mutate_at(vars(c("join", "left", "birth", "death")), ~ifelse(is.na(.),NA,
                                                                      ifelse(. %in% no_demo_values, NA,
                                                                             ifelse(. %in% yes_demo_values, 1, .))))


if(!file.exists("inputs/environment.Rdata")) {
  cause_death_f <- tcltk::tk_select.list(dplyr::pull(df_mortality_long[,"death_cause"]) %>% unique, title = "Cause Death related to Women",multiple = T)
}



if(!file.exists("inputs/environment.Rdata")) {
  # exp_sex_ratio
  yes_no <- svDialogs::dlg_message(paste0("Apply a 1:1 male to female ratio. No to provide your ratios."), type = "yesno")$res
  if(yes_no == "no"){
    right <- as.numeric(svDialogs::dlg_input(message= "Enter the male ratio",1)$res)
    left <- as.numeric(svDialogs::dlg_input(message= "Enter the female ratio",1)$res)
    exp_sex_ratio <- c(right,left)
  } else {
    exp_sex_ratio <- NULL
  }
  # exp_ratio_0_4
  yes_no <- svDialogs::dlg_message(paste0("Apply a 1:4 <5 years to >5 years ratio ratio. No to provide your ratios."), type = "yesno")$res
  if(yes_no == "no"){
    right <- as.numeric(svDialogs::dlg_input(message= "Enter the <5 years ratio",1)$res)
    left <- as.numeric(svDialogs::dlg_input(message= "Enter the >5 years ratio",4)$res)
    exp_ratio_0_4 <- c(right,left)
  } else {
    exp_ratio_0_4 <- NULL
  }
  # exp_ratio_2_5
  yes_no <- svDialogs::dlg_message(paste0("Apply a ~41% of individuals are <2 years of age of all children <5 years. No to provide your ratios."), type = "yesno")$res
  if(yes_no == "no"){
    right <- as.numeric(svDialogs::dlg_input(message= "Enter the <2 years ratio",7)$res)
    left <- as.numeric(svDialogs::dlg_input(message= "Enter the <5 years ratio",10)$res)
    exp_ratio_2_5 <- c(right,left)
  } else {
    exp_ratio_2_5 <- NULL
  }
  # exp_ratio_5_10
  yes_no <- svDialogs::dlg_message(paste0("Apply a ~52% of individuals are <5 years of age out of under-10 children. No to provide your ratios."), type = "yesno")$res
  if(yes_no == "no"){
    right <- as.numeric(svDialogs::dlg_input(message= "Enter the <2 years ratio",11)$res)
    left <- as.numeric(svDialogs::dlg_input(message= "Enter the <5 years ratio",10)$res)
    exp_ratio_5_10 <- c(right,left)
  } else {
    exp_ratio_5_10 <- NULL
  }
  # exp_hh_size
  yes_no <- svDialogs::dlg_message(paste0("Apply a 5 for HH average size. No to provide your average size."), type = "yesno")$res
  if(yes_no == "no"){
    exp_hh_size <- as.numeric(svDialogs::dlg_input(message= "Enter the HH size",5)$res)
  } else {
    exp_hh_size <- NULL
  }

}


list_of_var <- c("date_dc","date_recall_event","enumerator","admin1","admin2","cluster",
                 "uuid_main","uuid_roster","sex_roster","age_roster","joined_roster","joined_date_roster",
                 "birth_roster","birthdate_roster","uuid_left","sex_left","age_left","birth_left",
                 "birthdate_left","joined_left","joined_date_left","left_date_left","uuid_died",
                 "sex_died","age_died","birth_died","birthdate_died","joined_died",
                 "joined_date_died","date_death","death_cause","death_location","cause_death_f",
                 "exp_sex_ratio","exp_ratio_0_4","exp_ratio_2_5","exp_ratio_5_10","exp_hh_size",
                 "label_colname","path.sheet.with.main",
                 "path.sheet.with.roster","path.sheet.with.leavers","path.sheet.with.death", "smart",
                 "male","female","date_dc_reformat","date_recall_reformat","date_join_reformat",
                 "date_birth_reformat","date_left_reformat","date_death_reformat",
                 "unknown", "injury_trauma", "illness", "no_demo_values", "yes_demo_values",
                 "current_location","during_migration","last_place","other_place")

if(!file.exists("inputs/environment.Rdata")){
  save(list = list_of_var, file = "inputs/environment.Rdata")
}
```

#### <strong>`r paste0("Slicer Dates: ",min_filter," / ", max_filter)`</strong>

## Introduction

```{r, results='asis'}
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",3), collapse=""), " ", "What is this tool?"))
  cat('\nThe Mortality Data Quality and Plausibility Report serves as a crucial tool for assessing the reliability and accuracy of the data collection of Mortality indicators across different assessments. This comprehensive analysis is designed to identify and address potential issues within the data, ensuring that field teams are being informed on potential issues detected in the data collection.\n\nThe report provides a detailed examination of the datasets, employing a variety of metrics and methodologies to evaluate data quality and plausibility. This includes checks for completeness, consistency, and accuracy of the data collected. This report aims to uncover any discrepancies, outliers, or anomalies that may suggest data collection, entry errors, or underlying issues that could impact the integrity of the findings.</p>')
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",3), collapse=""), " ", "What is in this tool?")) 
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",4), collapse=""), " ", "Demographic SECTION"))
  cat('\nThis section includes:\n\n- Age Distribution of the HH Roster Individuals')
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",4), collapse=""), " ", "Mortality SECTION"))
  cat('\nThis section includes:\n\n- Overall Plausibility Report / By Enumerator\n- All the flags related to Mortality (details shown for each flag in the section)\n- Number of deaths(overall and under 5)/joiners/leavers as well as person times.\n- Plots showing the crude, under 5, and birth rates.')

  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",3), collapse=""), " ", "What to do next?"))
  cat('\nPlease check each flag and the <strong>ACTION</strong> related to it and act accordingly.\n\nAnother output will be associated to this HTML, the Excel file of the flags that were fired and requires follow-up with the field team. Please check the README tab in the excel file. This file will again be generated with the full data during the cleaning of the dataset. So please do use this file during data collection and relate to it in the final one to be filled.')
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",3), collapse=""), " ", "Feedback"))
  cat('\nFeedback on improvements to this product can be done through reaching out to:\n\n-abraham.azar@impact-initiatives.org \n\n-impact.geneva.phu@impact-initiatives.org')
```

## Mortality {.tabset .tabset-fade}
```{r, include = FALSE}
## Read the Plausibility excel file
overall_mort_plaus <- openxlsx::read.xlsx("resources/overall_plaus.xlsx", fillMergedCells = TRUE, sheet = "MORT") %>%
  dplyr::distinct()

df_mortality_long <- impactR4PHU::add_persontime(df_mortality_long,
                                                 smart =F)

flag_mortality <- impactR4PHU::check_mortality_flags(df = df_mortality_long,
                                                   cause_death_f = cause_death_f)

results_mort <- impactR4PHU::create_mortality_plaus(df_mortality = df_mortality_long,
                                                    exp_sex_ratio = exp_sex_ratio,
                                                    exp_ratio_0_4 = exp_ratio_0_4,
                                                    exp_ratio_2_5 = exp_ratio_2_5,
                                                    exp_ratio_5_10 = exp_ratio_5_10,
                                                    exp_hh_size = exp_hh_size)
  
results_mort_enum <- impactR4PHU::create_mortality_plaus(df_mortality = df_mortality_long,
                                                         exp_sex_ratio = exp_sex_ratio,
                                                         exp_ratio_0_4 = exp_ratio_0_4,
                                                         exp_ratio_2_5 = exp_ratio_2_5,
                                                         exp_ratio_5_10 = exp_ratio_5_10,
                                                         exp_hh_size = exp_hh_size,
                                                         grouping = "enumerator")

result_mort_pivot <- results_mort %>%
  dplyr::mutate_all(., as.character) %>%
  tidyr::pivot_longer(cols = everything(),names_to = "Criteria",
               values_to = "Score") %>%
  filter(stringr::str_starts(Criteria,"plaus_"))


overall_mort_plaus_overall <- overall_mort_plaus %>% 
  dplyr::left_join(result_mort_pivot, by = c("flag_name"="Criteria")) %>% 
  dplyr::mutate_all(., ~ifelse(is.na(.),"NA",.)) 

mort <- flextable::flextable(overall_mort_plaus_overall)
  
final_table <- impactR4PHU::create_plaus_table_nut_mort(mort)

```

### Demographics


#### Age pyramid in years disaggregated by gender 

```{r, message=FALSE}
impactR4PHU::plot_age_pyramid(df_mortality_long %>% 
                                filter(is.na(left),
                                       is.na(death)))
```

#### 2.	Age pyramid in years disaggregated by gender per enumerator

```{r, results='asis', message=FALSE}
list_enum <- df_mortality_long[["enumerator"]]%>% unique
list_flex_enum <- list()
for (i in list_enum) {
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",5), collapse=""), " ", "<strong>Enumerator: ",i,"</strong>"))
  subch(impactR4PHU::plot_age_pyramid(df_mortality_long %>% 
                                  filter(is.na(left),
                                         is.na(death),
                                         !!rlang::sym("enumerator") == i)),
        fig_height = 5, fig_width = 7)
}

```

#### Histogram of age in years 

```{r, message=FALSE}
impactR4PHU::plot_age_distribution(df_mortality_long %>% 
                                     filter(is.na(left),
                                            is.na(death)),
                                   year_or_month = "year",
                                   max_age = 10)
```

#### Histogram of age in years per enumerator

```{r, fig.height=8, message=FALSE}
impactR4PHU::plot_age_distribution(df_mortality_long %>% 
                                     filter(is.na(left),
                                            is.na(death)),
                                   year_or_month = "year",
                                   max_age = 10,
                                   by_group = "enumerator")
```

#### Histogram of age in months 

```{r, fig.width = 10, warning=FALSE, message=FALSE}
impactR4PHU::plot_age_distribution(raw.hh_roster,
                                   year_or_month = "month",
                                   breaks = 1)
```

#### Histogram of age in months per enumerator

```{r, fig.height=8, fig.width = 10, warning=FALSE}
plot_raw.hh_roster <- raw.hh_roster %>% 
  dplyr::rename(uuid = uuid_roster) 
plot_raw.main <- raw.main %>% 
  dplyr::rename(uuid = uuid_main)

impactR4PHU::plot_age_distribution(plot_raw.hh_roster %>% 
                                     dplyr::left_join(select(plot_raw.main, c("uuid", enumerator))),
                                   year_or_month = "month",
                                   by_group = "enumerator",
                                   breaks = 1)
```


### Data Quality Mortality {.tabset .tabset-fade}

#### Plausibility {.tabset .tabset-fade}

##### Overall

```{r}
final_table
```

```{r, results='asis'}
result_mort_pivot_enum <- results_mort_enum %>% 
    dplyr::mutate_all(., as.character) %>% 
    tidyr::pivot_longer(-group,names_to = "Criteria",
                 values_to = "Score") %>% 
    filter(stringr::str_starts(Criteria,"plaus_"))

list_enum <- results_mort_enum$group %>% unique
list_flex_enum <- list()
for (i in list_enum) {
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",5), collapse=""), " ", "<strong>",i,"</strong>"))
  overall_mort_plaus_enum <- overall_mort_plaus %>% 
    dplyr::left_join(result_mort_pivot_enum %>% filter(group == i), by = c("flag_name"="Criteria")) %>% 
    dplyr::mutate_all(., ~ifelse(is.na(.),"NA",.)) %>% 
    dplyr::select(-group)

  mort <- flextable::flextable(overall_mort_plaus_enum)

  final_table_mort_enum <- impactR4PHU::create_plaus_table_nut_mort(mort)
  subch(final_table_mort_enum)
  list_flex_enum <- append(list_flex_enum,final_table_mort_enum)
}
```


```{r, results='asis'}
flag_description <- readxl::read_excel("resources/flag_description.xlsx", sheet = "MORT")

# raw.flag.mort <- flag_mortality %>% 
#   dplyr::left_join(select(cause_join, c(uuid, flag_cause_death)), by ="uuid")

flags_mort_columns <- names(flag_mortality)[stringr::str_starts(names(flag_mortality),"flag_")]

overall_flag <- tibble()

for(flag in flags_mort_columns) {
  flag_overall <- flag_mortality %>%
    dplyr::select(enumerator, !!rlang::sym(flag)) %>%
    filter(!is.na(!!rlang::sym(flag))) %>%
    dplyr::mutate(flag := flag) %>%
    dplyr::group_by(flag) %>%
    dplyr::summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>%
    dplyr::mutate(percentage_flaggged = paste0(round((flagged/num_samples)*100,2),"%")) %>%
    dplyr::ungroup()
  if(nrow(flag_overall)>0){
    overall_flag <- rbind(overall_flag,flag_overall)
  }
}
add_to_html.title("Overall Flag Table")
subch(DT::datatable(overall_flag,
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50),
                                      c('All')),
                    paging = T)))

for(flag in flags_mort_columns) {
  flag_rational <- flag_description %>%
    filter(flag_name %in% flag) %>%
    dplyr::pull(Rationale)
  flag_action <- flag_description %>%
    filter(flag_name %in% flag) %>%
    dplyr::pull(Action)
  flag_by_enum <- flag_mortality %>%
    dplyr::select(enumerator, !!rlang::sym(flag)) %>%
    filter(!is.na(!!rlang::sym(flag))) %>%
    dplyr::mutate(flag := flag) %>%
    dplyr::group_by(flag,enumerator) %>%
    dplyr::summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>%
    dplyr::mutate(percentage_flagged = paste0(round((flagged/num_samples)*100,2),"%")) %>%
    dplyr::ungroup() %>%
    dplyr::select(-1)
  if(nrow(flag_by_enum)>0){
    add_to_html.title(flag)
    cat("\n")
    cat(paste("<em><strong>Rational</strong>: ",flag_rational,"</em>\n"))
    if(!is.null(flag_action)){
      cat("\n")
      cat(paste("<em><strong>Action</strong>: ",flag_action,"</em>\n"))
    }
    subch(DT::datatable(flag_by_enum,
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50),
                                      c('All')),
                    paging = T)))
  }
}

```

### Results

#### Number of Death/Joiners/Leavers & Person Time per Enumerator

```{r, include=FALSE}
table_djl_enum <- df_mortality_long %>% 
  dplyr::group_by(enumerator) %>% 
  dplyr::summarise(Leavers = sum(as.numeric(left), na.rm = T),
                   Joiners = sum(as.numeric(join), na.rm = T),
                   Death = sum(as.numeric(death), na.rm = T),
                   `Death Under 5` = sum(as.numeric(death_under5), na.rm = T),
                   `Person Time` = sum(as.numeric(person_time), na.rm = T),
                   `Person Time Under 5` = sum(as.numeric(under_5_pt), na.rm = T))

total <- table_djl_enum %>% 
  dplyr::group_by() %>% 
  dplyr::summarise(Leavers = sum(as.numeric(Leavers), na.rm = T),
                   Joiners = sum(as.numeric(Joiners), na.rm = T),
                   Death = sum(as.numeric(Death), na.rm = T),
                   `Death Under 5` = sum(as.numeric(`Death Under 5`), na.rm = T),
                   `Person Time` = sum(as.numeric(`Person Time`), na.rm = T),
                   `Person Time Under 5` = sum(as.numeric(`Person Time Under 5`), na.rm = T)) %>% 
  dplyr::mutate(enumerator = "Total") %>% 
  dplyr::relocate(enumerator, .before = 1)

table_djl_enum <- bind_rows(table_djl_enum, total)
```

```{r, results='asis'}
DT::datatable(table_djl_enum)
```

#### Mortality Rates

```{r, include=FALSE}
crude <- results_mort %>%
  dplyr::mutate(`point.est` = as.numeric(cdr),
                `95%lci` = as.numeric(stringr::str_extract(cdr_ci,"(?<=\\[)[^\\s\\-]*")),
                `95%uci` = as.numeric(stringr::str_remove(stringr::str_extract(cdr_ci,"(?<=-)[^\\]]*")," "))) %>% 
  dplyr::select(`point.est`,`95%lci`,`95%uci`) %>% 
  dplyr::mutate(variable = "cmr")
  
under5 <- results_mort %>%
  dplyr::mutate(`point.est` = as.numeric(u5dr),
                `95%lci` = as.numeric(stringr::str_extract(u5dr_ci,"(?<=\\[)[^\\s\\-]*")),
                `95%uci` = as.numeric(stringr::str_remove(stringr::str_extract(u5dr_ci,"(?<=-)[^\\]]*")," "))) %>% 
  dplyr::select(`point.est`,`95%lci`,`95%uci`) %>% 
  dplyr::mutate(variable = "u5mr")

results.summary <- rbind(crude,under5) %>% 
  dplyr::relocate(variable, .before = 1)
```

```{r, results='asis'}
DT::datatable(results.summary)
```

```{r, include=FALSE}
plot_results.summary <- ggplot2::ggplot(results.summary %>% 
                                               mutate(variable = case_when(variable == "cmr"~"Crude",
                                                                           variable == "u5mr"~"Under 5")), ggplot2::aes(x = variable)) +
  ggplot2::geom_hline(yintercept=1, linetype='dotted', color = 'black', size =1)+
  ggplot2::geom_hline(yintercept=2, linetype='dotted', color = 'red', size =1)+
  ggplot2::geom_errorbar(ggplot2::aes(ymin =`95%lci`, ymax = `95%uci`, width = 0.2, color = "red"))+
  ggplot2::geom_text(ggplot2::aes(x = variable, y = `95%lci`, label = `95%lci`, vjust = 1.5, color = "red", fontface = "bold"), size = 3)+
  ggplot2::geom_text(ggplot2::aes(x = variable, y = `95%uci`, label = `95%uci`, vjust = -0.5, color = "red", fontface = "bold"), size = 3)+
  ggplot2::geom_point(ggplot2::aes(y = point.est), color = "blue")+
  ggplot2::geom_text(ggplot2::aes(x = variable, y = point.est, label = point.est, hjust = -0.5), size = 3, color = "blue", fontface = "bold")+
  ggplot2::scale_y_continuous(limits=c(0, if(max(results.summary$`95%uci`)<2){
    2
  } else {
    max(results.summary$`95%uci`)
  }))+
  ggplot2::theme(legend.position = "none", axis.title.y = ggplot2::element_blank())+
  ggplot2::xlab("Overall Mortality Rates")+ 
  ggplot2::labs(caption = c("Black Dotted Line: Crude Threshold (WHO)", "Red Dotted Line: Under 5 Threshold (WHO)")) + 
  ggplot2::theme(plot.caption = ggplot2::element_text(hjust = c(0.2,0.8),color = c("black","red")))
```

```{r}
plot_results.summary
```

#### Birth Rates

```{r, include=FALSE}
birth <- results_mort %>%
  dplyr::mutate(`point.est` = as.numeric(birth_rate),
                `95%lci` = as.numeric(stringr::str_extract(birth_rate_ci,"(?<=\\[)[^\\s\\-]*")),
                `95%uci` = as.numeric(stringr::str_remove(stringr::str_extract(birth_rate_ci,"(?<=-)[^\\]]*")," "))) %>% 
  dplyr::select(`point.est`,`95%lci`,`95%uci`) %>% 
  dplyr::mutate(variable = "Birth")
  
results.summary.birth <- birth %>% 
  dplyr::relocate(variable, .before = 1)
```

```{r, results='asis'}
DT::datatable(results.summary.birth)
```

```{r, include=FALSE}
plot_results.summary.birth <- ggplot2::ggplot(results.summary.birth, ggplot2::aes(x = variable)) +
  ggplot2::geom_errorbar(ggplot2::aes(ymin =`95%lci`, ymax = `95%uci`, width = 0.2, color = "red"))+
  ggplot2::geom_text(ggplot2::aes(x = variable, y = `95%lci`, label = `95%lci`, vjust = 1.5, color = "red", fontface = "bold"), size = 3)+
  ggplot2::geom_text(ggplot2::aes(x = variable, y = `95%uci`, label = `95%uci`, vjust = -0.5, color = "red", fontface = "bold"), size = 3)+
  ggplot2::geom_point(ggplot2::aes(y = point.est), color = "blue")+
  ggplot2::geom_text(ggplot2::aes(x = variable, y = point.est, label = point.est, hjust = -0.5), size = 3, color = "blue", fontface = "bold")+
  ggplot2::scale_y_continuous(limits=c(0, max(results.summary.birth$`95%uci`)))+
  ggplot2::theme(legend.position = "none", axis.title.y = ggplot2::element_blank())+
  ggplot2::xlab("Overall Birth Rates")
```

```{r}
plot_results.summary.birth
```

